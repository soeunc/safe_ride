<!DOCTYPE html>
<html
        lang="en" xmlns:sec="http://www.w3.org/1999/xhtml"
        xmlns:th="http://www.thymeleaf.org"
>

<head>
    <th:block th:replace="~{common/header :: headerFragment}"></th:block>
    <!--ğŸ‘‡ì—¬ê¸°ì— ê¸°íƒ€ header ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
    <style>
        #topInfo {
            height: 130px;
        }

        #riding-record {
            display: inline-block; /* ê°€ë¡œë¡œ ë‚˜ì—´í•˜ê¸° ìœ„í•´ blockë ˆë²¨ ìš”ì†Œë¥¼ inline-blockë ˆë²¨ë¡œ ì „í™˜ */
            width: 33%; /* ì˜ì—­ í¬ê¸° ì§€ì • ì•ˆí•´ì£¼ë©´ inline ë ˆë²¨ì²˜ëŸ¼ ë‚´ìš©ë¬¼ ë§Œí¼ë§Œ ì°¨ì§€í•˜ê¸° ë•Œë¬¸ì— í¬ê¸° ì§€ì • */
            border: 2px solid aqua;
            background: orange;
        }

        #prifile-update {
            display: inline-block; /* ê°€ë¡œë¡œ ë‚˜ì—´í•˜ê¸° ìœ„í•´ blockë ˆë²¨ ìš”ì†Œë¥¼ inline-blockë ˆë²¨ë¡œ ì „í™˜ */
            width: 50%; /* ì˜ì—­ í¬ê¸° ì§€ì • ì•ˆí•´ì£¼ë©´ inline ë ˆë²¨ì²˜ëŸ¼ ë‚´ìš©ë¬¼ ë§Œí¼ë§Œ ì°¨ì§€í•˜ê¸° ë•Œë¬¸ì— í¬ê¸° ì§€ì • */
            border: 2px solid aqua;
            background: orange;
        }

        #introduce {
            display: inline-block;
        }

        .badge-grade {
            width: 70px;
        }

        #chart {
            width: 800px;
            height: 400px;
        }
    </style>
    <!--ğŸ‘† ì—¬ê¸°ì— ê¸°íƒ€ header ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ ğŸ‘†-->
</head>

<body>
<div class="wrapper">
    <th:block th:replace="~{common/sidebar :: sidebarFragment}"></th:block>

    <div class="main">
        <th:block th:replace="~{common/navbar :: navbarFragment}"></th:block>
        <main>
            <div class="container mt-4">
                <!--ğŸ‘‡ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
                <div class="container mt-4">
                    <div id="topInfo">
                        <h1 id="introduce">ë°˜ê°‘ìŠµë‹ˆë‹¤, <span sec:authentication="name"></span>ë‹˜!</h1>
                        <span th:if="${#strings.equals(badges.getGrade(), 'QUICK_BOARD')}">
                        <img class="badge-grade" src="/img/badge/kickboard.png">
                        </span>
                        <span th:if="${#strings.equals(badges.getGrade(), 'BYCICLE')}">
                            <img class="badge-grade" src="/img/badge/bicycle.png">
                        </span>
                        <span th:if="${#strings.equals(badges.getGrade(), 'SCOOTER')}">
                            <img class="badge-grade" src="/img/badge/scooter.png">
                        </span>
                        <span th:if="${#strings.equals(badges.getGrade(), 'MOTOR_CYCLE')}">
                            <img class="badge-grade" src="/img/badge/motorcycle.png">
                        </span>
                    </div>
                    <div id="container">
                        <!--ë¼ì´ë”© ê¸°ë¡-->
                        <div id="riding-record">
                            <h2>ë¼ì´ë”© ê¸°ë¡</h2>
                            <!--ë¼ì´ë”© ê¸°ë¡ì´ ì—†ì„ ë–„-->
                            <div th:if="${#strings.isEmpty(ridingRecord.getTotalRecord())}">
                                <h3>ê¸°ë¡ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤!</h3>
                            </div>
                            <!--ë¼ì´ë”© ê¸°ë¡ì´ ì¡´ì¬í•œë‹¤ë©´-->
                            <div th:unless="${#strings.isEmpty(ridingRecord.getTotalRecord())}">
                                <div id="total-record">
                                    <h3>ì´ ê¸°ë¡</h3>
                                    <span id="totalRecord"></span>
                                </div>
                                <div id="weekly-record">
                                    <h3>ì£¼ê°„ ê¸°ë¡</h3>
                                    <span id="weeklyRecord"></span>
                                </div>
                                <!--ì˜¤ëŠ˜ì ê¸°ë¡ì´ ì—†ì„ ë–„-->
                                <div th:if="${#strings.isEmpty(ridingRecord.getTodayRecord())}">
                                    <h4>ì˜¤ëŠ˜ ê¸°ë¡ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤! ì—´ì‹¬íˆ ë‹¬ë ¤ë´ìš”! :)</h4>
                                </div>
                                <div th:unless="${#strings.isEmpty(ridingRecord.getTodayRecord())}">
                                    <h3>ì˜¤ëŠ˜ ê¸°ë¡</h3>
                                    <span id="todayRecord"></span>
                                </div>
                            </div>
                            <form>
                                <input id="todayRecordInput" name="todayRecord" type="number" required
                                       placeholder="ì˜¤ëŠ˜ ê¸°ë¡ì„ ì…ë ¥" maxlength="4">
                                <button class="btn btn-primary btn" type="button" id="todaySubmit">ì˜¤ëŠ˜ ê¸°ë¡ ì…ë ¥</button>
                            </form>
                        </div>
                        <div id="chart">
                            <canvas id="bar-chart"></canvas>
                        </div>
                        <!--í”„ë¡œí•„ ìˆ˜ì •-->
                        <section class="py-5">
                            <div class="container px-5">
                                <!-- login form-->
                                <div class="bg-light rounded-3 py-5 px-4 px-md-5 mb-5">
                                    <div class="row gx-5 justify-content-center">
                                        <div class="col-lg-8 col-xl-6">
                                            <h2 class="text-center mb-5">íšŒì›ì •ë³´ ìˆ˜ì •</h2>
                                            <form id="updateForm" onsubmit="return false">
                                                <div class="form-floating mb-3">
                                                    <input class="form-control" id="password" name="password" type="password" onkeyup="passwordValidCkFnc()" maxlength="20" required placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                                                    <label for="password">íŒ¨ìŠ¤ì›Œë“œ</label>
                                                </div>
                                                <div class="form-floating mb-3">
                                                    <input class="form-control" id="passwordCk" name="passwordCk" type="password" maxlength="20" required placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
                                                    <button class="btn btn-info" id="passwordMatchCk" onclick="passwordMatchCkFnc()">íŒ¨ìŠ¤ì›Œë“œ ì¼ì¹˜ì—¬ë¶€ í™•ì¸</button>
                                                    <span id="passwordCkMsg"></span>
                                                    <label for="passwordCk">íŒ¨ìŠ¤ì›Œë“œ í™•ì¸</label>
                                                </div>
                                                <div class="form-floating mb-3">
                                                    <input class="form-control" id="email" name="email" type="text" th:value="${member.email}" maxlength="30" disabled>
                                                    <label for="email">ì´ë©”ì¼</label>
                                                </div>
                                                <div class="form-floating mb-3">
                                                    <input class="form-control" id="nickName" name="nickName" type="text" th:value="${member.nickname}" onkeyup="nickNameValidFunc()" maxlength="30">
                                                    <button class="btn btn-info" id="duplicateCkForNickname" onclick="duplicateCkForNicknameFnc()">ë‹‰ë„¤ì„ ì¤‘ë³µí™•ì¸</button>
                                                    <span id="nickNameCkMsg"></span>
                                                    <label for="nickName">ë‹‰ë„¤ì„</label>
                                                </div>
                                                <div class="form-floating mb-3">
                                                    <input class="form-control" id="phoneNumber" name="phoneNumber" type="text" th:value="${member.phoneNumber}" onkeyup="phoneNumberVaildFnc()" maxlength="11">
                                                    <span id="phoneNumberMsg"></span>
                                                    <label for="phoneNumber">ì „í™”ë²ˆí˜¸</label>
                                                </div>
                                                <div class="form-floating mb-3 date_item">
                                                    <input class="form-control" id="birthday" name="birthday" th:value="${member.getBirthday()}" maxlength="8" disabled>
                                                    <label for="birthday">ìƒë…„ì›”ì¼</label>
                                                </div>
                                                <div class="d-grid"><button class="btn btn-primary btn-lg" id="submitBtn" type="button">Submit</button></div>
                                            </form>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </section>


                    <form action="/safe-ride/logout">
                        <input type="submit" value="ë¡œê·¸ì•„ì›ƒ">
                    </form>
                    <a href="/safe-ride">í™ˆìœ¼ë¡œ</a>
                </div>
                <!--ğŸ‘†ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘†-->
            </div>
        </main>
        <th:block th:replace="~{common/footer :: footerFragment}"></th:block>
    </div>
</div>

<!--ğŸ‘‡ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
<!--ajax-->
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<!--chart.js-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script th:inline="javascript">

    window.onload = function () {
        //alert
        const alertMsg = [[${msg}]];

        if (alertMsg) {
            alert(alertMsg);
        }
    }
    //html ëœ¨ê³  ì‹¤í–‰
    //ì´ / ì£¼ê°„ / ì˜¤ëŠ˜ ê¸°ë¡ ë‚˜íƒ€ë‚´ê¸°
    $(function() {
        const totalRecord = parseFloat([[${ridingRecord.getTotalRecord()}]]) * 0.001;
        const weeklyRecord = parseFloat([[${ridingRecord.getWeeklyRecord()}]]) * 0.001;
        const todayRecord = parseFloat([[${ridingRecord.getTodayRecord()}]]) * 0.001;
        $('#totalRecord').text(totalRecord.toFixed(3) + "km íƒ”ì–´ìš”! :)");
        $('#weeklyRecord').text(weeklyRecord.toFixed(3) + "km íƒ”ì–´ìš”! :)");
        $('#todayRecord').text(todayRecord.toFixed(3) + "km íƒ”ì–´ìš”! :)");
    });

    const weeklyRecordList = [[${ridingRecord.weeklyRecordList}]];
    new Chart(document.getElementById("bar-chart"), {
        type: 'bar',
        data: {
            labels: [
                weeklyRecordList[0].createDate.split('T')[0],
                weeklyRecordList[1].createDate.split('T')[0],
                weeklyRecordList[2].createDate.split('T')[0],
                weeklyRecordList[3].createDate.split('T')[0],
                weeklyRecordList[4].createDate.split('T')[0],
                weeklyRecordList[5].createDate.split('T')[0],
                weeklyRecordList[6].createDate.split('T')[0],

            ],
            datasets: [
                {
                    label: "Population (millions)",
                    backgroundColor: ["#ff0000", "#ff7f27", "#ffd900", "#00db07", "#00b7ff", "#3700dc", "#a600ff"],
                    data: [
                        weeklyRecordList[0].todayRecord,
                        weeklyRecordList[1].todayRecord,
                        weeklyRecordList[2].todayRecord,
                        weeklyRecordList[3].todayRecord,
                        weeklyRecordList[4].todayRecord,
                        weeklyRecordList[5].todayRecord,
                        weeklyRecordList[6].todayRecord,
                    ]
                }
            ]
        },
        options: {
            legend: {display: false},
            title: {
                display: true,
                text: 'ì£¼ê°„ ë¼ì´ë”© ê¸°ë¡'
            }
        }
    });
    const myNickName = [[${member.nickname}]];
    const myPhoneNumber = [[${member.phoneNumber}]];
    const todayRecord = [[${ridingRecord.getTodayRecord()}]];
    //íŒ¨ìŠ¤ì›Œë“œ ì •ê·œì‹ ì²´í¬ìš© flagë³€ìˆ˜
    let passwordCk = false;
    //íŒ¨ìŠ¤ì›Œë“œ ì¤‘ë³µí™•ì¸ìš© flagë³€ìˆ˜
    let passwordMatchCk = false;
    //ë‹‰ë„¤ì„ ì •ê·œì‹ ì²´í¬ìš© flagë³€ìˆ˜
    let nicknameCk = false;
    //ë‹‰ë„¤ì„ ì¤‘ë³µí™•ì¸ìš© flag ë³€ìˆ˜
    let nicknameDuplicateCk = false;
    //ì „í™”ë²ˆí˜¸ ì •ê·œì‹ ì²´í¬ìš© flagë³€ìˆ˜
    let phoneNumberCk = false;

    //ë‹‰ë„¤ì„ ì¤‘ë³µí™•ì¸
    function duplicateCkForNicknameFnc(){
        let nickName = $('#nickName').val();
        //ë³¸ì¸ì˜ ë‹‰ë„¤ì„ì´ë¼ë©´
        if (myNickName === nickName){
            alert("ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            nicknameDuplicateCk = true;
        } else if(nickName.trim()===''){
            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        } else {
            $.ajax({
                type : "POST",
                url : "/safe-ride/duplicateCkForNickname",
                data : {
                    nickName : nickName
                },
                success : function (result){
                    if (result===1){ // ë‹‰ë„¤ì„ì´ ì´ë¯¸ ì¡´ì¬í•œë‹¤ë©´
                        alert("ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.");
                        nicknameDuplicateCk = false;
                    } else if(result===0) {
                        alert("ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                        nicknameDuplicateCk = true;
                    } else {
                        alert("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                    }
                },
                error:function (error){
                    alert("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”!" + error);
                }
            });
        }
    }
    //ë¹„ë°€ë²ˆí˜¸ ì •ê·œì‹
    function passwordValidCkFnc() {
        //ì˜ì–´ ìˆ«ì ì¡°í•© 8ìë¦¬ ì´ìƒ~25ì ì´í•˜
        const regExp = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,20}$/;
        let password = $('#password').val();
        let passwordCkMsg = $('#passwordCkMsg');
        if (!regExp.test(password)){
            passwordCkMsg.text("ì˜ì–´ ìˆ«ì ì¡°í•© 8~20ì ì´ë‚´ë¡œ í•´ì£¼ì„¸ìš”!");
            passwordCkMsg.css('color', "red");
            passwordCk = false;
        } else {
            passwordCkMsg.text("ì‚¬ìš©ê°€ëŠ¥í•©ë‹ˆë‹¤!!");
            passwordCkMsg.css('color', "blue");
            passwordCk = true;
        }
    }
    //ë‹‰ë„¤ì„ ì •ê·œì‹
    function nickNameValidFunc(){
        //ì˜ë¬¸ ëŒ€/ì†Œë¬¸ìë‚˜ í•œê¸€ë¡œ ì‹œì‘. ì˜ë¬¸ ëŒ€/ì†Œë¬¸ìì™€ í•œê¸€, ìˆ«ìë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°
        const regExp =/^[ã„±-ã…ê°€-í£a-zA-Z0-9]{2,10}$/;
        //2~10ì‚¬ì´ì˜ ê¸¸ì´

        let nickName = $('#nickName').val();
        let nickNameCkMsg = $('#nickNameCkMsg');
        if (!regExp.test(nickName)){
            nickNameCkMsg.text("2~10ì ì´ë‚´ë¡œ í•´ì£¼ì„¸ìš”!(íŠ¹ìˆ˜ë¬¸ìë¶ˆê°€)");
            nickNameCkMsg.css('color', "red");
            nicknameCk = false;
        } else {
            nickNameCkMsg.text("ì‚¬ìš©ê°€ëŠ¥í•©ë‹ˆë‹¤!!");
            nickNameCkMsg.css('color', "blue");
            nicknameCk = true;
        }
    }
    //ì „í™”ë²ˆí˜¸ì •ê·œì‹
    function phoneNumberVaildFnc() {
        const regExp = /^01([0|1|6|7|8|9]?)-?([0-9]{3,4})-?([0-9]{4})$/;

        let phoneNumber = $('#phoneNumber').val();
        let phoneNumberMsg = $('#phoneNumberMsg');

        if (!regExp.test(phoneNumber)){
            phoneNumberMsg.text("ì „í™”ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!");
            phoneNumberMsg.css('color', "red");
            phoneNumberCk = false;
        } else {
            phoneNumberMsg.text("ì‚¬ìš©ê°€ëŠ¥í•©ë‹ˆë‹¤!!");
            phoneNumberMsg.css('color', "blue");
            phoneNumberCk = true;
        }
    }
    //íŒ¨ìŠ¤ì›Œë“œ ì¼ì¹˜ì—¬ë¶€ í™•ì¸
    function passwordMatchCkFnc() {
        //ë¹„ë°€ë²ˆí˜¸ ì²´í¬
        let password = document.querySelector("#password").value;
        let passwordCk = document.querySelector("#passwordCk").value;
        if (password !== passwordCk || password === '' || passwordCk === ''){
            alert("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
            passwordMatchCk = false;
        } else {
            alert("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•©ë‹ˆë‹¤! ^^");
            passwordMatchCk = true;
        }
    }

    //ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
    $('#submitBtn').click(function (event){
        //ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€
        event.preventDefault();

        const passwordVal = $('#password').val();
        const passwordCkVal = $('#passwordCk').val();
        const emailVal = $('#email').val();
        const nickNameVal = $('#nickName').val();
        const phoneNumberVal = $('#phoneNumber').val();
        const birthdayVal = $('#birthday').val();

        //ë³¸ì¸ ë‹‰ë„¤ì„ì´ë¼ë©´ ë‹‰ë„¤ì„ ì •ê·œì‹ ì²´í¬ ì—¬ë¶€ íŒ¨ìŠ¤
        if (nickNameVal === myNickName){
            nicknameCk = true;
        }
        //ë³¸ì¸ ì „í™”ë²ˆí˜¸ë¼ë©´ ë‹‰ë„¤ì„ ì •ê·œì‹ ì²´í¬ ì—¬ë¶€ íŒ¨ìŠ¤
        if (phoneNumberVal === myPhoneNumber){
            phoneNumberCk = true;
        }


        if (
            passwordVal.trim()===''||
            passwordCkVal.trim()===''||
            emailVal.trim()===''||
            nickNameVal.trim()===''||
            passwordCkVal.trim()===''||
            birthdayVal.trim()===''
        ){
            alert("ë¹„ì–´ìˆëŠ” ê°’ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!");
        } else if (passwordCk !== true){
            alert("ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!")
        }
        //ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì²´í¬ ì—¬ë¶€ í™•ì¸
        else if (passwordMatchCk !== true){
            alert("ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì²´í¬ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!")
        }
        else if (nicknameCk !== true){
            alert("ì˜¬ë°”ë¥¸ ë‹‰ë„¤ì„ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!")
        }
        else if (nicknameDuplicateCk !== true){
            alert("ë‹‰ë„¤ì„ ì¤‘ë³µì²´í¬ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!")
        }
        else if (phoneNumberCk !== true){
            alert("ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!")
        } else {
            const formData = {
                password: passwordVal,
                passwordCk: passwordCkVal,
                nickName: nickNameVal,
                phoneNumber : phoneNumberVal,
            };

            $.ajax({
                type : "POST",
                url : "/safe-ride/myprofile/update",
                contentType: "application/json",
                data: JSON.stringify(formData),
                success : function (result){
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    window.location.href = "/safe-ride/myprofile";
                },
                error:function (error){
                    alert("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." + error);
                }
            });
        }
    });

    //ì˜¤ëŠ˜ ê¸°ë¡ ì…ë ¥
    $('#todaySubmit').click(function (event){
        event.preventDefault();
        let todayRecordInput = $('#todayRecordInput').val();
        //í•œë²ˆì— 1000í‚¤ë¡œ ì´ìƒì„ íƒ€ëŠ” ì‚¬ëŒì¼ë•Œ
        if (todayRecord >= 1000000 || todayRecordInput > 1000000){
            alert("ì˜¤ëŠ˜ì ì…ë ¥ ë²”ìœ„ ì´ˆê³¼ì…ë‹ˆë‹¤! :) (1000kmê¹Œì§€ ì…ë ¥ê°€ëŠ¥)")
        } else {
            const formData = {
                todayRecord : todayRecordInput
            };
            $.ajax({
                type : "POST",
                url : "/safe-ride/myprofile/create-today",
                contentType: "application/json",
                data: JSON.stringify(formData),
                success : function (result){
                    alert("ì˜¤ëŠ˜ ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.^^");
                    window.location.href = "/safe-ride/myprofile";
                },
                error:function (error){
                    alert("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." + error);
                }
            });
        }
    });

</script>
<!--ğŸ‘†ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘†-->
<script src="/js/app.js"></script>
</body>
</html>