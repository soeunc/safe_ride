<!DOCTYPE html>
<html lang="en">

<head>
  <link href="/css/app.css" rel="stylesheet">
  <th:block th:replace="~{common/header :: headerFragment}"></th:block>
  <!--ğŸ‘‡ì—¬ê¸°ì— ê¸°íƒ€ header ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->

  <!--ğŸ‘† ì—¬ê¸°ì— ê¸°íƒ€ header ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ ğŸ‘†-->
</head>

<body>
<div class="wrapper">
  <th:block th:replace="~{common/sidebar :: sidebarFragment}"></th:block>

  <div class="main">
    <th:block th:replace="~{common/navbar :: navbarFragment}"></th:block>
    <main class="content">
      <div class="container mt-4">
        <!--ğŸ‘‡ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
        <div class="col-12">
          <div class="row g-3 p-3" style="border-bottom: 2px solid black;">
            <div class="col-4 d-flex justify-content-center align-items-center" id="ride_img"></div>
            <div class="col-8 d-flex justify-content-center align-items-center" id="ride_value" style="font-size: 3rem;font-weight: bold;">ë°ì´í„° í†µì‹ ì¤‘</div>
          </div>
          <div class="row g-3 p-3" style="border-bottom: 2px solid black;">
            <div class="col-4">
              <div class="col-12 p-1 d-flex justify-content-center" id="sky_img"></div>
              <div class="col-12 p-1 d-flex justify-content-center" id="sky_value" style="font-size: 3rem;font-weight: bold;"></div>
            </div>
            <div class="col-8">
              <div class="col-12" id="tmp" style="font-size: 4rem;font-weight: bold;padding-left: 95px;"></div>
              <div class="col-12">
                <div class="row g-3">
                  <div class="col-4">
                    <div class="col-12 p-1 d-flex justify-content-center" id="vec_img">
                      <img alt="" src="/img/weather/wind.png" width="75" height="75">
                    </div>
                    <div class="col-12 p-1 d-flex justify-content-center" id="vec" style="font-size: 1.5rem;font-weight: bold;"></div>
                    <div class="col-12 p-1 d-flex justify-content-center" id="wsd" style="font-size: 1.25rem;font-weight: bold;color: blue;"></div>
                  </div>
                  <div class="col-4">
                    <div class="col-12 p-1 d-flex justify-content-center" id="reh_img">
                      <img alt="" src="/img/weather/drop.png" width="75" height="75">
                    </div>
                    <div class="col-12 p-1 d-flex justify-content-center" style="font-size: 1.5rem;font-weight: bold;">ìŠµë„</div>
                    <div class="col-12 p-1 d-flex justify-content-center" id="reh_value" style="font-size: 1.25rem;font-weight: bold;color: blue;"></div>
                  </div>
                  <div class="col-4">
                    <div class="col-12 p-1 d-flex justify-content-center" id="pcp_img">
                      <img alt="" src="/img/weather/rainy_mount.png" width="75" height="75">
                    </div>
                    <div class="col-12 p-1 d-flex justify-content-center" style="font-size: 1.5rem;font-weight: bold;">ê°•ìˆ˜ëŸ‰</div>
                    <div class="col-12 p-1 d-flex justify-content-center" id="pcp_value" style="font-size: 1.25rem;font-weight: bold;color: blue;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row g-3 p-3 justify-content-center">
            <div class="col-5">
              <div class="col-12 d-flex justify-content-center" style="font-size: 1.5rem;font-weight: bold;">ë¯¸ì„¸ë¨¼ì§€</div>
              <div class="col-12 d-flex justify-content-center" id="pm10status" style="font-size: 1rem;font-weight: bold;">í†µì‹ ì¤‘</div>
            </div>
            <div class="col-5">
              <div class="col-12 d-flex justify-content-center" style="font-size: 1.5rem;font-weight: bold;">ì´ˆë¯¸ì„¸ë¨¼ì§€</div>
              <div class="col-12 d-flex justify-content-center" id="pm25status" style="font-size: 1rem;font-weight: bold;">í†µì‹ ì¤‘</div>
            </div>
          </div>
        </div>
        <!--ğŸ‘†ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘†-->
      </div>
    </main>
    <th:block th:replace="~{common/footer-weather :: footerFragment}"></th:block>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="/js/app.js"></script> <!-- template -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> <!-- jQuery -->
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/dayjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/plugin/isBetween.min.js"></script>
<script>
  dayjs.extend(dayjs_plugin_isBetween);
</script>
<!--ğŸ‘‡ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
<script>
  let globalWeatherData, globalDustData;
  getCurrentPosition();

  // í˜„ì¬ gps í˜¸ì¶œ
  function getCurrentPosition() {
    navigator.geolocation.getCurrentPosition((position) => {
      fetchWeather(position.coords.latitude, position.coords.longitude);
    }, (err) => {
      if (err.code === err.PERMISSION_DENIED) {
        console.log('gps ì‚¬ìš© ê±°ë¶€')
      }
    }, {
      timeout: 15000
    });
  }

  // ì¸¡ì •ì†Œ ë¬¸ì œì¸ì§€ í™•ì¸ì„ ìœ„í•œ í•˜ë“œì½”ë”©ë°©ì‹
  /*
  function getCurrentPosition() {
    // í•˜ë“œ ì½”ë”©í•  ìœ„ê²½ë„ ê°’
    const latitude = 37.1234; // ì›í•˜ëŠ” ìœ„ë„ ê°’
    const longitude = -122.1234; // ì›í•˜ëŠ” ê²½ë„ ê°’

    // fetchWeather í•¨ìˆ˜ì— í•˜ë“œ ì½”ë”©í•œ ìœ„ê²½ë„ ê°’ì„ ì „ë‹¬
    fetchWeather(latitude, longitude);
  } */

  function degStr(deg) {
    const value = Number(deg)
    if(value === 0) return 'ë¶'
    else if(value > 0 && value < 45) return 'ë¶ë¶ë™'
    else if(value === 45) return 'ë¶ë™'
    else if(value > 45 && value < 90) return 'ë™ë¶ë™'
    else if(value === 90) return 'ë™'
    else if(value > 90 && value < 135) return 'ë™ë‚¨ë™'
    else if(value === 135) return 'ë‚¨ë™'
    else if(value > 135 && value < 180) return 'ë‚¨ë‚¨ë™'
    else if(value === 180) return 'ë‚¨'
    else if(value > 180 && value < 225) return 'ë‚¨ë‚¨ì„œ'
    else if(value === 225) return 'ë‚¨ì„œ'
    else if(value > 225 && value < 270) return 'ì„œë‚¨ì„œ'
    else if(value === 270) return 'ì„œ'
    else if(value > 270 && value < 315) return 'ì„œë¶ì„œ'
    else if(value === 315) return 'ë¶ì„œ'
    else if(value > 315 && value < 360) return 'ë¶ë¶ì„œ'
  }

  function isCurrentTimeWithinRange(time) {
    const next = dayjs().add(1, 'day')
    const startTime = dayjs().hour(6).minute(0).second(0); // ì˜¤ì „ 6ì‹œ
    const endTime = dayjs().hour(18).minute(0).second(0);  // ì˜¤í›„ 6ì‹œ
    const nextStartTime = next.hour(6).minute(0).second(0); // ì˜¤ì „ 6ì‹œ
    const nextEndTime = next.hour(18).minute(0).second(0);  // ì˜¤í›„ 6ì‹œ
    // í˜„ì¬ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ ì‚¬ì´ì— ìˆëŠ”ì§€ í™•ì¸
    return time.isBetween(startTime, endTime) || time.isBetween(nextStartTime, nextEndTime);
  }

  function parseWeatherFastData(weatherData) {
    if(weatherData.PTY[0].fcstValue === '0') {
      if(weatherData.SKY[0].fcstValue === '1') {
        if(isCurrentTimeWithinRange(dayjs())) {
          $('#sky_img').html('<img alt="" src="/img/weather/sunny.png" width="150" height="150">');
          $('#sky_value').text('ë§‘ìŒ');
        } else {
          $('#sky_img').html('<img alt="" src="/img/weather/night.png" width="150" height="150">');
          $('#sky_value').text('ë§‘ìŒ');
        }
      } else {
        if(isCurrentTimeWithinRange(dayjs())) {
          $('#sky_img').html('<img alt="" src="/img/weather/sunny_cloudy.png" width="150" height="150">');
          $('#sky_value').text('êµ¬ë¦„');
        } else {
          $('#sky_img').html('<img alt="" src="/img/weather/night_cloudy.png" width="150" height="150">');
          $('#sky_value').text('êµ¬ë¦„');
        }
      }
    } else if(weatherData.PTY[0].fcstValue === '1') { // ë¹„
      $('#sky_img').html('<img alt="" src="/img/weather/rainy_power.png" width="150" height="150">');
      $('#sky_value').text('ë¹„');
    } else if(weatherData.PTY[0].fcstValue === '2') { // ë¹„/ëˆˆ
      $('#sky_img').html('<img alt="" src="/img/weather/snow_rainy.png" width="150" height="150">');
      $('#sky_value').text('ë¹„/ëˆˆ');
    } else if(weatherData.PTY[0].fcstValue === '3') { // ëˆˆ
      $('#sky_img').html('<img alt="" src="/img/weather/snow.png" width="150" height="150">');
      $('#sky_value').text('ëˆˆ');
    } else if(weatherData.PTY[0].fcstValue === '5') { // ë¹—ë°©ìš¸
      $('#sky_img').html('<img alt="" src="/img/weather/rainy.png" width="150" height="150">');
      $('#sky_value').text('ë¹—ë°©ìš¸');
    } else if(weatherData.PTY[0].fcstValue === '6') { // ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼
      $('#sky_img').html('<img alt="" src="/img/weather/rainy_snow_small.png" width="150" height="150">');
      $('#sky_value').text('ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼');
    } else if(weatherData.PTY[0].fcstValue === '7') { // ëˆˆë‚ ë¦¼
      $('#sky_img').html('<img alt="" src="/img/weather/snow_small.png" width="150" height="150">');
      $('#sky_value').text('ëˆˆë‚ ë¦¼');
    }
  }

  function calculateGetVilageFcstTime(requestHour) {
    if(requestHour === '02' || requestHour === '03' || requestHour === '04') {
      return '0200'
    } else if(requestHour === '05' || requestHour === '06' || requestHour === '07') {
      return '0500'
    } else if(requestHour === '08' || requestHour === '09' || requestHour === '10') {
      return '0800'
    } else if(requestHour === '11' || requestHour === '12' || requestHour === '13') {
      return '1100'
    } else if(requestHour === '14' || requestHour === '15' || requestHour === '16') {
      return '1400'
    } else if(requestHour === '17' || requestHour === '18' || requestHour === '19') {
      return '1700'
    } else if(requestHour === '20' || requestHour === '21' || requestHour === '22') {
      return '2000'
    } else if(requestHour === '23' || requestHour === '00' || requestHour === '01') {
      return '2300'
    }
  }

  function calculateGetVilageFcstDate(base_date, base_time) {
    if(base_time.substring(0, 2) === '00' || base_time.substring(0, 2) === '01') {
      return {
        date: dayjs(base_date).subtract(1, 'day').format('YYYYMMDD'),
        time: '2300'
      }
    } else {
      return {
        date: base_date,
        time: calculateGetVilageFcstTime((base_time).substring(0,2))
      }
    }
  }

  // ë‚ ì§œ,ì‹œê°„ì„ ê³ ì •ëœ ë°œí‘œì‹œê°„ëŒ€ì— ë§ì¶°ì„œ ë³€í™˜í•´ì¤Œ
  function fetchWeather(lat, lon) {
    const currentDate = dayjs().format('YYYYMMDD')
    const currentTime = dayjs().format('HH00')
    const dateObj = calculateGetVilageFcstDate(currentDate, currentTime);
    $.ajax({
      type: "GET",
      url: `http://localhost:8080/safe-ride/weather/fcst?base_date=${dateObj.date}&base_time=${dateObj.time}&lat=${lat}&lon=${lon}`,
      data: {}, // GET ìš”ì²­ ì‹œì—” ë¹„ì›Œë‘”ë‹¤.
      success: function(res) { // ì„œë²„ì—ì„œ ë°›ì€ ê²°ê³¼
        console.log(res);
        if(res.response) {
          const data = res.response.body.items.item;
          const result = {};
          data.forEach((el) => {
            const { category } = el;
            if (!result[category]) result[category] = [];
            result[category].push(el)
          })
          console.log(result)
          globalWeatherData = result;
          parseWeatherFastData(result);
          $('#tmp').text(result.TMP[0].fcstValue + 'â„ƒ');
          $('#vec').text(degStr(result.VEC[0].fcstValue));
          $('#wsd').text(result.WSD[0].fcstValue + 'm/s');
          $('#reh_value').text(result.REH[0].fcstValue + '%');
          $('#pcp_value').text(result.PCP[0].fcstValue + (result.PCP[0].fcstValue === 'ê°•ìˆ˜ì—†ìŒ' ? '' : 'mm'));
          getTMPosition(lat, lon);
        } else {
          $('#tmp').text('ì„œë²„ ì˜¤ë¥˜');
          $('#tmp').css('font-size', '1rem');
          $('#ride_value').text('ì„œë²„ ì˜¤ë¥˜');
          $('#ride_value').css('color', 'black');
        }
      },
      error: function(error) {
        console.error(error);
      }
    })
  }

  function getTMPosition(lat, lon) {
    $.ajax({
      type: "GET",
      url: `http://localhost:8080/safe-ride/weather/trans-coord?lat=${lat}&lon=${lon}`,
      data: {}, // GET ìš”ì²­ ì‹œì—” ë¹„ì›Œë‘”ë‹¤.
      success: function(res) { // ì„œë²„ì—ì„œ ë°›ì€ ê²°ê³¼
        console.log(res);
        if(res.documents.length > 0) {
          getNearbyMsrstn(res.documents[0].x, res.documents[0].y);
        }
      },
      error: function(error) {
        console.error(error);
      }
    })
  }

  function getNearbyMsrstn(x, y) {
    $.ajax({
      type: "GET",
      url: `http://localhost:8080/safe-ride/weather/getNearbyMsrstnList?tmX=${x}&tmY=${y}`,
      data: {}, // GET ìš”ì²­ ì‹œì—” ë¹„ì›Œë‘”ë‹¤.
      success: function(res) { // ì„œë²„ì—ì„œ ë°›ì€ ê²°ê³¼
        console.log(res);
        if(res.response) {
          if(res.response.header.resultCode === '00') {
            getMsrAirData(res.response.body.items[0].stationName);
          }
        }
      },
      error: function(error) {
        console.error(error);
      }
    })
  }

  function getMsrAirData(stationName) {
    $.ajax({
      type: "GET",
      url: `http://localhost:8080/safe-ride/weather/airInfo?stationName=${stationName}&dataTerm=DAILY`,
      data: {}, // GET ìš”ì²­ ì‹œì—” ë¹„ì›Œë‘”ë‹¤.
      success: function(res) { // ì„œë²„ì—ì„œ ë°›ì€ ê²°ê³¼
        console.log(res);
        if(res.response) {
          const dust = res.response.body.items[0];
          if(dust) {
            checkPm10DustData(dust);
            checkPm25DustData(dust);
            globalDustData = dust;
            checkRideStatus();
          } else {
            $('#pm10status').text('í˜„ìœ„ì¹˜ ë°ì´í„°ì—†ìŒ');
            $('#pm10status').css('color', 'black');
            $('#pm10status').css('font-size', '2rem');
            $('#pm25status').text('í˜„ìœ„ì¹˜ ë°ì´í„°ì—†ìŒ');
            $('#pm25status').css('color', 'black');
            $('#pm25status').css('font-size', '2rem');
          }
        } else {
          $('#pm10status').text('ì„œë²„ ì˜¤ë¥˜');
          $('#pm10status').css('color', 'black');
          $('#pm25status').text('ì„œë²„ ì˜¤ë¥˜');
          $('#pm25status').css('color', 'black');
        }
      },
      error: function(error) {
        console.error(error);
      }
    })
  }

  function checkPm10DustData(dust) {
    $('#pm10status').css('font-size', '3.5rem');
    if(dust.pm10Value < 31) {
      $('#pm10status').text('ì¢‹ìŒ');
      $('#pm10status').css('color', 'blue');
    } else if(dust.pm10Value > 30 && dust.pm10Value < 51) {
      $('#pm10status').text('ë³´í†µ');
      $('#pm10status').css('color', 'green');
    } else if(dust.pm10Value > 50 && dust.pm10Value < 100) {
      $('#pm10status').text('ë‚˜ì¨');
      $('#pm10status').css('color', 'orange');
    } else if(dust.pm10Value === '-') { // í†µì‹ ì¥ì• 
      $('#pm10status').text('í†µì‹  ëŒ€ê¸°ì¤‘');
      $('#pm10status').css('color', 'black');
    } else {
      $('#pm10status').text('ë§¤ìš° ë‚˜ì¨');
      $('#pm10status').css('color', 'red');
    }
  }
  function checkPm25DustData(dust) {
    $('#pm25status').css('font-size', '3.5rem');
    if(dust.pm25Value < 16) {
      $('#pm25status').text('ì¢‹ìŒ');
      $('#pm25status').css('color', 'blue');
    } else if(dust.pm25Value > 15 && dust.pm25Value < 26) {
      $('#pm25status').text('ë³´í†µ');
      $('#pm25status').css('color', 'green');
    } else if(dust.pm25Value > 25 && dust.pm25Value < 51) {
      $('#pm25status').text('ë‚˜ì¨');
      $('#pm25status').css('color', 'orange');
    } else if(dust.pm25Value === '-') { // í†µì‹ ì¥ì• 
      $('#pm25status').text('í†µì‹  ëŒ€ê¸°ì¤‘');
      $('#pm25status').css('color', 'black');
    } else {
      $('#pm25status').text('ë§¤ìš° ë‚˜ì¨');
      $('#pm25status').css('color', 'red');
    }
  }

  function checkRideStatus() {
    if(globalWeatherData.PTY[0].fcstValue === '0') {
      if(globalDustData.pm10Value > 100 || globalDustData.pm25Value > 25) {
        // ë¯¸ì„¸, ì´ˆë¯¸ì„¸ë¨¼ì§€ ë‚˜ì¨ ì´ìƒì¼ë•Œ
        $('#ride_value').text('ë¼ì´ë”© í•˜ê¸° í˜ë“¤ì–´ìš”!');
        $('#ride_value').css('color', 'orange');
        $('#ride_img').html('<img alt="" src="/img/weather/dust3.png" width="150" height="150">');
      } else {
        // ê³µê¸° ìƒíƒœ ì¢‹ìŒ,ë³´í†µ
        if(Number(globalWeatherData.TMP[0].fcstValue) > 28 || Number(globalWeatherData.REH[0].fcstValue) > 68) {
          // ì˜¨ë„ 29ë„ ì´ìƒì¸ ê²½ìš°, ìŠµë„ 69% ì´ìƒì¸ ê²½ìš° ë„ˆë¬´ ë¥ê³  ë¶ˆì¾Œí•œ ìŠµë„
          $('#ride_value').text('ë¼ì´ë”© í•˜ê¸° í˜ë“¤ì–´ìš”!');
          $('#ride_value').css('color', 'orange');
          $('#ride_img').html('<img alt="" src="/img/weather/dust3.png" width="150" height="150">');
        } else {
          if(Number(globalWeatherData.TMP[0].fcstValue) < 5) {
            $('#ride_value').text('ë¼ì´ë”© í•˜ê¸° í˜ë“¤ì–´ìš”!');
            $('#ride_value').css('color', 'orange');
            $('#ride_img').html('<img alt="" src="/img/weather/dust3.png" width="150" height="150">');
          } else {
            $('#ride_value').text('ë¼ì´ë”© í•˜ê¸° ì¢‹ì•„ìš”!');
            $('#ride_value').css('color', 'blue');
            $('#ride_img').html('<img alt="" src="/img/weather/dust1.png" width="150" height="150">');
          }
        }
      }
    } else { // ê¸°ìƒ ìƒíƒœ ë¶ˆëŸ‰
      $('#ride_value').text('ë¼ì´ë”© í•˜ê¸° í˜ë“¤ì–´ìš”!');
      $('#ride_value').css('color', 'orange');
      $('#ride_img').html('<img alt="" src="/img/weather/dust3.png" width="150" height="150">');
    }
  }

</script>
<!--ğŸ‘†ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘†-->
</body>
</html>