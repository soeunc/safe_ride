<!DOCTYPE html>
<html lang="en">

<head>
  <link href="/css/app.css" rel="stylesheet">
  <th:block th:replace="~{common/header :: headerFragment}"></th:block>
  <!--ğŸ‘‡ì—¬ê¸°ì— ê¸°íƒ€ header ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->

  <!--ğŸ‘† ì—¬ê¸°ì— ê¸°íƒ€ header ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ ğŸ‘†-->
</head>

<body>
<div class="wrapper">
  <th:block th:replace="~{common/sidebar :: sidebarFragment}"></th:block>

  <div class="main">
    <th:block th:replace="~{common/navbar :: navbarFragment}"></th:block>
    <main class="content">
      <div class="container mt-4">
        <!--ğŸ‘‡ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
        <div class="col-12">
          <div class="row g-3 p-3" style="border-bottom: 2px solid black;">
            <div class="col-4"></div>
<!--            <div class="col-8">ë¼ì´ë”© í•˜ê¸° ì¢‹ì•„ìš”</div>-->
          </div>
          <div class="row g-3 p-3" style="border-bottom: 2px solid black;">
            <div class="col-4">
              <div class="col-12 p-1 d-flex justify-content-center" id="sky_img"></div>
              <div class="col-12 p-1 d-flex justify-content-center" id="sky_value" style="font-size: 3rem;font-weight: bold;"></div>
            </div>
            <div class="col-8">
              <div class="col-12" id="tmp" style="font-size: 4rem;font-weight: bold;padding-left: 25px;"></div>
              <div class="col-12">
                <div class="row g-3">
                  <div class="col-4">
                    <div class="col-12 p-1 d-flex justify-content-center" id="vec_img">
                      <img alt="" src="/img/weather/wind.png" width="75" height="75">
                    </div>
                    <div class="col-12 p-1 d-flex justify-content-center" id="vec" style="font-size: 1.5rem;font-weight: bold;"></div>
                    <div class="col-12 p-1 d-flex justify-content-center" id="wsd" style="font-size: 1.25rem;font-weight: bold;color: blue;"></div>
                  </div>
                  <div class="col-4">
                    <div class="col-12 p-1 d-flex justify-content-center" id="reh_img">
                      <img alt="" src="/img/weather/drop.png" width="75" height="75">
                    </div>
                    <div class="col-12 p-1 d-flex justify-content-center" style="font-size: 1.5rem;font-weight: bold;">ìŠµë„</div>
                    <div class="col-12 p-1 d-flex justify-content-center" id="reh_value" style="font-size: 1.25rem;font-weight: bold;color: blue;"></div>
                  </div>
                  <div class="col-4">
                    <div class="col-12 p-1 d-flex justify-content-center" id="pcp_img">
                      <img alt="" src="/img/weather/rainy_mount.png" width="75" height="75">
                    </div>
                    <div class="col-12 p-1 d-flex justify-content-center" style="font-size: 1.5rem;font-weight: bold;">ê°•ìˆ˜ëŸ‰</div>
                    <div class="col-12 p-1 d-flex justify-content-center" id="pcp_value" style="font-size: 1.25rem;font-weight: bold;color: blue;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row g-3 p-3 justify-content-between">
            <div class="col-4">
              <div class="col-12">ë¯¸ì„¸ë¨¼ì§€</div>
              <div class="col-12"></div>
            </div>
            <div class="col-4">
              <div class="col-12">ì´ˆë¯¸ì„¸ë¨¼ì§€</div>
              <div class="col-12"></div>
            </div>
          </div>
        </div>
        <!--ğŸ‘†ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘†-->
      </div>
    </main>
    <th:block th:replace="~{common/footer-weather :: footerFragment}"></th:block>
  </div>
</div>

<script src="/js/app.js"></script>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/dayjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/plugin/isBetween.min.js"></script>
<script>
  dayjs.extend(dayjs_plugin_isBetween);
</script>
<!--ğŸ‘‡ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
<script>
  getCurrentPosition();

  // í˜„ì¬ gps í˜¸ì¶œ
  function getCurrentPosition() {
    navigator.geolocation.getCurrentPosition((position) => {
      fetchWeather(position.coords.latitude, position.coords.longitude);
    }, (err) => {
      if (err.code === err.PERMISSION_DENIED) {
        console.log('gps ì‚¬ìš© ê±°ë¶€')
      }
    }, {
      timeout: 15000
    });
  }

  function degStr(deg) {
    const value = Number(deg)
    if(value === 0) return 'ë¶'
    else if(value > 0 && value < 45) return 'ë¶ë¶ë™'
    else if(value === 45) return 'ë¶ë™'
    else if(value > 45 && value < 90) return 'ë™ë¶ë™'
    else if(value === 90) return 'ë™'
    else if(value > 90 && value < 135) return 'ë™ë‚¨ë™'
    else if(value === 135) return 'ë‚¨ë™'
    else if(value > 135 && value < 180) return 'ë‚¨ë‚¨ë™'
    else if(value === 180) return 'ë‚¨'
    else if(value > 180 && value < 225) return 'ë‚¨ë‚¨ì„œ'
    else if(value === 225) return 'ë‚¨ì„œ'
    else if(value > 225 && value < 270) return 'ì„œë‚¨ì„œ'
    else if(value === 270) return 'ì„œ'
    else if(value > 270 && value < 315) return 'ì„œë¶ì„œ'
    else if(value === 315) return 'ë¶ì„œ'
    else if(value > 315 && value < 360) return 'ë¶ë¶ì„œ'
  }

  function isCurrentTimeWithinRange(time) {
    const next = dayjs().add(1, 'day')
    const startTime = dayjs().hour(6).minute(0).second(0); // ì˜¤ì „ 6ì‹œ
    const endTime = dayjs().hour(18).minute(0).second(0);  // ì˜¤í›„ 6ì‹œ
    const nextStartTime = next.hour(6).minute(0).second(0); // ì˜¤ì „ 6ì‹œ
    const nextEndTime = next.hour(18).minute(0).second(0);  // ì˜¤í›„ 6ì‹œ
    // í˜„ì¬ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ ì‚¬ì´ì— ìˆëŠ”ì§€ í™•ì¸
    return time.isBetween(startTime, endTime) || time.isBetween(nextStartTime, nextEndTime);
  }

  function parseWeatherFastData(weatherData) {
    if(weatherData.PTY[0].fcstValue === '0') {
      if(weatherData.SKY[0].fcstValue === '1') {
        if(isCurrentTimeWithinRange(dayjs())) {
          $('#sky_img').html('<img alt="" src="/img/weather/sunny.png" width="150" height="150">');
          $('#sky_value').text('ë§‘ìŒ');
        } else {
          $('#sky_img').html('<img alt="" src="/img/weather/night.png" width="150" height="150">');
          $('#sky_value').text('ë§‘ìŒ');
        }
      } else {
        if(isCurrentTimeWithinRange(dayjs())) {
          $('#sky_img').html('<img alt="" src="/img/weather/sunny_cloudy.png" width="150" height="150">');
          $('#sky_value').text('êµ¬ë¦„');
        } else {
          $('#sky_img').html('<img alt="" src="/img/weather/night_cloudy.png" width="150" height="150">');
          $('#sky_value').text('êµ¬ë¦„');
        }
      }
    } else if(weatherData.PTY[0].fcstValue === '1') { // ë¹„
      $('#sky_img').html('<img alt="" src="/img/weather/rainy_power.png" width="150" height="150">');
      $('#sky_value').text('ë¹„');
    } else if(weatherData.PTY[0].fcstValue === '2') { // ë¹„/ëˆˆ
      $('#sky_img').html('<img alt="" src="/img/weather/snow_rainy.png" width="150" height="150">');
      $('#sky_value').text('ë¹„/ëˆˆ');
    } else if(weatherData.PTY[0].fcstValue === '3') { // ëˆˆ
      $('#sky_img').html('<img alt="" src="/img/weather/snow.png" width="150" height="150">');
      $('#sky_value').text('ëˆˆ');
    } else if(weatherData.PTY[0].fcstValue === '5') { // ë¹—ë°©ìš¸
      $('#sky_img').html('<img alt="" src="/img/weather/rainy.png" width="150" height="150">');
      $('#sky_value').text('ë¹—ë°©ìš¸');
    } else if(weatherData.PTY[0].fcstValue === '6') { // ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼
      $('#sky_img').html('<img alt="" src="/img/weather/rainy_snow_small.png" width="150" height="150">');
      $('#sky_value').text('ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼');
    } else if(weatherData.PTY[0].fcstValue === '7') { // ëˆˆë‚ ë¦¼
      $('#sky_img').html('<img alt="" src="/img/weather/snow_small.png" width="150" height="150">');
      $('#sky_value').text('ëˆˆë‚ ë¦¼');
    }
  }

  function calculateGetVilageFcstTime(requestHour) {
    if(requestHour === '02' || requestHour === '03' || requestHour === '04') {
      return '0200'
    } else if(requestHour === '05' || requestHour === '06' || requestHour === '07') {
      return '0500'
    } else if(requestHour === '08' || requestHour === '09' || requestHour === '10') {
      return '0800'
    } else if(requestHour === '11' || requestHour === '12' || requestHour === '13') {
      return '1100'
    } else if(requestHour === '14' || requestHour === '15' || requestHour === '16') {
      return '1400'
    } else if(requestHour === '17' || requestHour === '18' || requestHour === '19') {
      return '1700'
    } else if(requestHour === '20' || requestHour === '21' || requestHour === '22') {
      return '2000'
    } else if(requestHour === '23' || requestHour === '00' || requestHour === '01') {
      return '2300'
    }
  }

  function calculateGetVilageFcstDate(base_date, base_time) {
    if(base_time.substring(0, 2) === '00' || base_time.substring(0, 2) === '01') {
      return {
        date: dayjs(base_date).subtract(1, 'day').format('YYYYMMDD'),
        time: '2300'
      }
    } else {
      return {
        date: base_date,
        time: calculateGetVilageFcstTime((base_time).substring(0,2))
      }
    }
  }

  // ë‚ ì§œ,ì‹œê°„ì„ ê³ ì •ëœ ë°œí‘œì‹œê°„ëŒ€ì— ë§ì¶°ì„œ ë³€í™˜í•´ì¤Œ
  function fetchWeather(lat, lon) {
    const currentDate = dayjs().format('YYYYMMDD')
    const currentTime = dayjs().format('HH00')
    const dateObj = calculateGetVilageFcstDate(currentDate, currentTime);
    $.ajax({
      type: "GET",
      url: `http://localhost:8080/safe-ride/weather?base_date=${dateObj.date}&base_time=${dateObj.time}&lat=${lat}&lon=${lon}`,
      data: {}, // GET ìš”ì²­ ì‹œì—” ë¹„ì›Œë‘”ë‹¤.
      success: function(res) { // ì„œë²„ì—ì„œ ë°›ì€ ê²°ê³¼
        console.log(res);
        const data = res.response.body.items.item;
        const result = {};
        data.forEach((el) => {
          const { category } = el;
          if (!result[category]) result[category] = [];
          result[category].push(el)
        })
        console.log(result)
        parseWeatherFastData(result);
        $('#tmp').text(result.TMP[0].fcstValue + 'â„ƒ');
        $('#vec').text(degStr(result.VEC[0].fcstValue));
        $('#wsd').text(result.WSD[0].fcstValue + 'm/s');
        $('#reh_value').text(result.REH[0].fcstValue + '%');
        $('#pcp_value').text(result.PCP[0].fcstValue + (result.PCP[0].fcstValue === 'ê°•ìˆ˜ì—†ìŒ' ? '' : 'mm'));
      }
    })
  }

</script>
<!--ğŸ‘†ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘†-->
</body>
</html>