<!DOCTYPE html>
<html lang="en">

<head>
  <link href="/css/app.css" rel="stylesheet">
  <th:block th:replace="~{common/header :: headerFragment}"></th:block>
  <!--ğŸ‘‡ì—¬ê¸°ì— ê¸°íƒ€ header ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=kp0utn2vxk"></script>
  <!--ğŸ‘† ì—¬ê¸°ì— ê¸°íƒ€ header ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ ğŸ‘†-->
</head>

<body>
<div class="wrapper">
  <th:block th:replace="~{common/sidebar :: sidebarFragment}"></th:block>

  <div class="main">
    <th:block th:replace="~{common/navbar :: navbarFragment}"></th:block>
    <main class="content">
      <!--ğŸ‘‡ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
      <div class="container mt-4" style="position: relative;">
        <h3>ê³µì˜ìì „ê±° í˜„í™©</h3>
        <div class="container">
          <div class="row">
            <!-- ì²« ë²ˆì§¸ ì¹´ë“œ -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">ì£¼ì†Œ ê²€ìƒ‰</h5>
                </div>
                <div class="card-body">
                  <p class="card-text"> ê²€ìƒ‰ ì§€ì—­ì˜ 2km ì´ë‚´ ëŒ€ì—¬ì†Œì™€ ìì „ê±° ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.</p>
                  <button onclick="goPopup();" class="btn btn-primary">ğŸ” ì£¼ì†Œ ê²€ìƒ‰</button>
                </div>
              </div>
            </div>
            <!-- ë‘ ë²ˆì§¸ ì¹´ë“œ -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">í˜„ì¬ ìœ„ì¹˜ ê²€ìƒ‰</h5>
                </div>
                <div class="card-body">
                  <p class="card-text"> í˜„ì¬ ìœ„ì¹˜ì˜ 2km ì´ë‚´ ëŒ€ì—¬ì†Œì™€ ìì „ê±° ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.</p>
                  <button id="getPositionBtn" class="btn btn-success"> ğŸ§­í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ê²€ìƒ‰</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h6><strong>í˜„ì¬ ì œê³µë˜ëŠ” ì§€ìì²´ : ì„œìš¸íŠ¹ë³„ì‹œ, ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ, ëŒ€ì „ê´‘ì—­ì‹œ</strong></h6>
        <h6>2024ë…„ë„ ì—°ë§ 7ê°œ ì§€ìì²´ì˜ ë°ì´í„°ê°€ ì¶”ê°€ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.</h6>
        <form id="addressForm" action="/public-bicycle/getAddressPosition" method="post" class="mt-4">
          <input type="hidden" id="roadFullAddr" name="roadFullAddr">
          <input type="hidden" id="roadAddrPart1" name="roadAddrPart1">
        </form>

        <!-- ğŸ‘€ ê²€ìƒ‰ ê²°ê³¼ -->
        <div class="row">
          <div class="col-12">
            <div class="mt-3 content-custom">
              <div class="custom-box" th:classappend="${!isSearched ? 'background-default' :
                     (page.isEmpty() ? 'background-no-data' : 'background-has-data')}">
                <p class="px-0 mb-0" th:if="${!isSearched}">ì£¼ì†Œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”! ğŸ§</p>
                <p class="px-0 mb-0" th:if="${isSearched and page.isEmpty()}">í•´ë‹¹ ì§€ì—­ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¢</p>
                <p class="px-0 mb-0" th:if="${isSearched and !page.isEmpty()}"><strong><span
                        th:text="${infoResponse.getFullAddress()}"></span></strong> ì§€ì—­ì˜ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤ ğŸ‘€</p>
              </div>
            </div>

            <!-- ê²€ìƒ‰ ê²°ê³¼ ì§€ë„ -->
            <div id="map" th:if="${isSearched}" style="width:100%;height:400px;"></div>

            <!-- ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” -->
            <div th:if="${isSearched and !page.isEmpty()}" class="table-responsive mt-3">
              <div class="custom-box background-has-data-light">
                <p class="px-0 mb-0"
                   th:utext="${totalInfoDto != null ?
       'ì´ <strong>' + totalInfoDto.totalStation + '</strong>ê°œì˜ ëŒ€ì—¬ì†Œì—ì„œ ' +
       '<strong>' + totalInfoDto.totalBicycle + '</strong>ê°œì˜ ìì „ê±°ë¥¼ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤ğŸš²'
       : 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'}">
                  ê³µì˜ìì „ê±° ëŒ€ì—¬ì†Œ ë° ìì „ê±° í˜„í™©
                </p>
              </div>

              <table class="table table-striped">
                <thead>
                <tr>
                  <th>ëŒ€ì—¬ì†Œ ID</th>
                  <th>ë„ë¡œëª… ì£¼ì†Œ</th>
                  <th>
                    <a th:href="@{/public-bicycle(page=${page.number}, sort='bcyclTpkctNocs', direction='desc')}"
                       class="btn"
                       th:classappend="${sort == 'bcyclTpkctNocs' ? 'btn-danger btn-sm' : 'btn-secondary btn-sm'}">ë³´ìœ 
                      ìì „ê±° ìˆ˜ğŸ”¼</a>
                  </th>
                  <th>
                    <a th:href="@{/public-bicycle(page=${page.number}, sort='distance', direction='asc')}"
                       class="btn"
                       th:classappend="${sort == 'distance' ? 'btn-primary btn-sm' : 'btn-secondary btn-sm'}">ê±°ë¦¬ğŸ”½</a>
                  </th>
                  <th>ìƒì„¸ ë³´ê¸°</th>
                  <th>ì§€ë„</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="info : ${page.content}">
                  <td th:text="${info.rntstnId}"></td>
                  <td th:text="${info.roadNmAddr}"></td>
                  <td><strong style="color: red"
                              th:text="${info.bcyclTpkctNocs != null ? info.bcyclTpkctNocs : 'ì •ë³´ ì—†ìŒ'}"></strong></td>
                  <td><strong style="color: dodgerblue;" th:text="${info.distance} + ' km'"></strong></td>
                  <td>
                    <button th:data-id="${info.rntstnId}" onclick="showDetails(this.getAttribute('data-id'))"
                            class="btn btn-info">ìƒì„¸ë³´ê¸°
                    </button>
                  </td>
                  <td>
                    <button th:data-lat="${info.lat}" th:data-lng="${info.lot}" th:data-bckcnt="${info.bcyclTpkctNocs}" th:data-nm="${info.rntstnNm}" th:data-addr="${info.roadNmAddr}"
                            onclick="showMap(this.getAttribute('data-lat'), this.getAttribute('data-lng'),  this.getAttribute('data-bckcnt'), this.getAttribute('data-nm'), this.getAttribute('data-addr'))"
                            class="btn btn-primary">Go
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë§í¬ -->
            <div th:if="${isSearched and not page.isEmpty()}" class="mt-4">
              <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                  <li th:classappend="${page.first ? 'disabled' : ''}" class="page-item">
                    <a th:href="@{/public-bicycle(page=${page.number - 1}, sort=${sort != null ? sort : 'distance'}, direction=${sort == 'distance' ? 'asc' : 'desc'})}"
                       th:unless="${page.first}"
                       class="page-link">Previous</a>
                  </li>
                  <li th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
                      th:classappend="${i == page.number ? 'active' : ''}" class="page-item">
                    <!-- í˜„ì¬ ì •ë ¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ë©´ì„œ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ í´ë¦­í•  ìˆ˜ ìˆëŠ” ë§í¬ -->
                    <a th:href="@{/public-bicycle(page=${i}, sort=${sort != null ? sort : 'distance'}, direction=${sort == 'distance' ? 'asc' : 'desc'})}"
                       th:text="${i + 1}" class="page-link"></a>
                  </li>
                  <li th:classappend="${page.last ? 'disabled' : ''}" class="page-item">
                    <a th:href="@{/public-bicycle(page=${page.number + 1}, sort=${sort != null ? sort : 'distance'}, direction=${sort == 'distance' ? 'asc' : 'desc'})}"
                       th:unless="${page.last}" class="page-link">Next</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- ë¡œë”© ë§ˆí¬ì—… -->
      <div id="loading"
           style="display:none; position:absolute; top:0; left:0; right:0; bottom:0; background-color:rgba(241,241,241,0.8); z-index:9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
          <img src="/img/loading.gif" alt="Loading..."/>
        </div>
      </div>
      <!-- ğŸ‘† ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ ğŸ‘†-->
    </main>
    <th:block th:replace="~{common/footer :: footerFragment}"></th:block>
  </div>
</div>

<script src="/js/app.js"></script>
<!--ğŸ‘‡ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
<script th:inline="javascript">

    // ğŸªŸ ë„ë¡œëª…ì£¼ì†Œ Popup ê´€ë ¨ script
    // ë„ë¡œëª… ì£¼ì†Œ íŒì—… ì—°ê²°
    function goPopup() {
        pop = window.open("/public-bicycle/jusoPopup", "pop", "width=570, height=420, scrollbars=yes");
    }

    // ë„ë¡œëª… ì£¼ì†Œ íŒì—… ê²€ìƒ‰ ê²°ê³¼ ì½œë°±
    function jusoCallBack(roadFullAddr, roadAddrPart1) {
        console.log("ë„ë¡œëª… ì£¼ì†Œ: " + roadAddrPart1);
        console.log("ì „ì²´ ì£¼ì†Œ: " + roadFullAddr);
        document.getElementById('roadFullAddr').value = roadFullAddr;
        document.getElementById('roadAddrPart1').value = roadAddrPart1;
        // ë¡œë”© í™”ë©´ í‘œì‹œ
        document.getElementById('loading').style.display = 'block';
        // í¼ ì œì¶œ
        document.getElementById('addressForm').submit();
    }


    // ğŸš©ì¢Œí‘œ ê´€ë ¨ script

    // // positionPopup í˜¸ì¶œ
    // document.getElementById('getPositionBtn').addEventListener('click', function() {
    //     // íŒì—… ì—´ê¸°
    //
    // });
    // ìœ„ì¹˜ ê°€ì ¸ì™€ì„œ sendPositionToServer ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function () {
        // ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.getElementById('getPositionBtn').addEventListener('click', function () {
            // ë¡œë”© í™”ë©´ í‘œì‹œ
            window.open('/public-bicycle/positionPopup', 'locationConsent', 'width=400,height=300');
            // document.getElementById('loading').style.display = 'block';
            // navigator.geolocation.getCurrentPosition(function (position) {
            //     console.log('ìœ„ì¹˜ ì •ë³´ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë°›ì•˜ìŠµë‹ˆë‹¤.');
            //     sendPositionToServer(position);
            // }, showErrorMsg);
        });

        // ì—ëŸ¬ ë°œìƒ ì‹œ ì²˜ë¦¬
        function showErrorMsg(error) {
            var errorMessage = '';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "ì‚¬ìš©ìê°€ ìœ„ì¹˜ ì •ë³´ ì œê³µì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ìš”ì²­ì´ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.";
                    break;
                default:
                    errorMessage = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                    break;
            }
            console.log(errorMessage);
            document.getElementById('loading').style.display = 'none';  // ë¡œë”© í™”ë©´ ìˆ¨ê¹€
        }

        // ì„œë²„ë¡œ ìœ„ì¹˜ ë°ì´í„°ë¥¼ ë³´ë‚´ëŠ” í•¨ìˆ˜
        window.sendPositionToServer = function (position) {
            var userLng = position.coords.longitude; // ê²½ë„
            var userLat = position.coords.latitude; // ìœ„ë„
            console.log('ê²½ë„ : ' + userLng);
            console.log('ìœ„ë„ : ' + userLat);

            fetch('/public-bicycle/getUserPosition', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    lng: userLng,
                    lat: userLat
                })
            }).then(response => {
                if (response.ok) {
                    window.location.reload(); // ì‘ë‹µ ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
                } else {
                    console.error('ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }).catch(error => {
                console.error('Error:', error);
            }).finally(() => {
                document.getElementById('loading').style.display = 'none';  // ì‘ë‹µ ì™„ë£Œ í›„ ë¡œë”© í™”ë©´ ìˆ¨ê¹€
            });
        }
    });


    //ğŸ—ºï¸ ì§€ë„ ê´€ë ¨ script
    // ì§€ë„ ìƒì„±
    var defaultLng = [[${infoResponse?.getSearchedPoint()?.getLng()}]] || ' 126.979338';
    var defaultLat = [[${infoResponse?.getSearchedPoint()?.getLat()}]] || '37.570502';

    var mapOptions = {
        center: new naver.maps.LatLng(defaultLat, defaultLng),
        zoom: 14
    };

    var map = new naver.maps.Map('map', mapOptions);


    var defaultMarkerContent = '<img src="' + '/img/pin_default.png" alt="" ' +
        'style="margin: 0px; padding: 0px; border: 0px solid transparent; display: block; max-width: none; max-height: none; ' +
        '-webkit-user-select: none; position: absolute; width: 22px; height: 35px; left: 0px; top: 0px;">';

    var defaultMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(defaultLat, defaultLng),
        map: map,
        icon: {
            content: defaultMarkerContent,
            size: new naver.maps.Size(22, 35),
            anchor: new naver.maps.Point(11, 35)
        }
    });


    // ì§€ë„ ë§ˆì»¤ (ìœ„ì¹˜, ì‚¬ìš©ê°€ëŠ¥ ìì „ê±° ìˆ˜ëŸ‰)
    var stations = [[${stations}]];
    stations.forEach(function (station) {
        var bikeCount = station.bcyclTpkctNocs ? station.bcyclTpkctNocs : 'X';
        console.log(bikeCount);
        var markerContent =
            '<div style="background-color: #007bff; ' +
            'color: white; ' +
            'width: 30px; ' +
            'height: 30px; ' +
            'line-height: 20px; ' +
            'text-align: center; ' +
            'border-radius: 50%; ' +
            'font-size: 14px; ' +
            'font-weight: bold; ' +
            'border: 2px solid black;">'
            + bikeCount
            + '</div>';
        var marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(station.lat, station.lot),
            map: map,
            icon: {
                content: markerContent,
                size: new naver.maps.Size(30, 30),
                anchor: new naver.maps.Point(15, 15)
            }
        });

        // ë§ˆì»¤ì— ëŒ€í•œ ì •ë³´(ëŒ€ì—¬ì†Œ ë„ë¡œëª… ì£¼ì†Œëª…)ì°½ ìƒì„±
        var infoWindowContent = '<div class="iw_inner">' +
            '<h5><strong> ğŸ”–' + station.rntstnNm + '</strong> </h5>' +
            '<p> ğŸ—ºï¸ ' +
            '<a>' + station.roadNmAddr + '</a>' +
            ' </p>' +
            '</div>';
        var infoWindow = new naver.maps.InfoWindow({
            content: infoWindowContent
        });

        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
        naver.maps.Event.addListener(marker, "click", function (e) {
            if (infoWindow.getMap()) {
                infoWindow.close();
            } else {
                infoWindow.open(map, marker); // í´ë¦­ ì‹œ ì •ë³´ì°½ ì—´ê¸°
            }
        });

    });

    // ì§€ë„ì—ì„œë³´ê¸° í™œì„±í™”
    var currentInfoWindow = null; // í˜„ì¬ ì •ë³´ì°½ì„ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
    function showMap(lat, lng, bckcnt, nm, addr) {
        // ë¬¸ìì—´ë¡œ ë„˜ì–´ì˜¨ ìœ„ë„ì™€ ê²½ë„ë¥¼ ì‹¤ìˆ˜í˜•ìœ¼ë¡œ ë³€í™˜
        var lat = parseFloat(lat);
        var lng = parseFloat(lng);
        var bikeCount = parseInt(bckcnt);
        var rntstnNm = nm;
        var roadNmAddr = addr;

        // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ìƒˆë¡œìš´ ìœ„ë„ì™€ ê²½ë„ë¡œ ì„¤ì •
        var newCenter = new naver.maps.LatLng(lat, lng);
        map.setCenter(newCenter);
        map.setZoom(16, true);

        var markerContent =
            '<div style="background-color: red; ' +  // ë°°ê²½ìƒ‰ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½
            'color: white; ' +
            'width: 30px; ' +
            'height: 30px; ' +
            'line-height: 20px; ' +
            'text-align: center; ' +
            'border-radius: 50%; ' +
            'font-size: 14px; ' +
            'font-weight: bold; ' +
            'border: 2px solid black;">'
            + bikeCount  // ì—¬ê¸°ì— ì‹¤ì œ í•„ìš”í•œ ê°’ì„ ë„£ìœ¼ì„¸ìš”.
            + '</div>';

        // ì„ íƒëœ ìœ„ì¹˜ì— ë§ˆì»¤ í‘œì‹œ
        var marker = new naver.maps.Marker({
            position: newCenter,
            map: map,
            icon: {
                content: markerContent,
                size: new naver.maps.Size(30, 30),
                anchor: new naver.maps.Point(15, 15)
            }
        });

        // ë§ˆì»¤ì— ëŒ€í•œ ì •ë³´(ëŒ€ì—¬ì†Œ ë„ë¡œëª… ì£¼ì†Œëª…)ì°½ ìƒì„±
        var infoWindowContent = '<div class="iw_inner">' +
            '<h5><strong> ğŸ”–' + rntstnNm + '</strong> </h5>' +
            '<p> ğŸ—ºï¸ ' +
            '<a>' + roadNmAddr + '</a>' +
            ' </p>' +
            '</div>';

        // ê¸°ì¡´ ì •ë³´ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ê¸°
        if (currentInfoWindow) {
            currentInfoWindow.close();
        }

        // ìƒˆ ì •ë³´ì°½ ìƒì„±
        currentInfoWindow = new naver.maps.InfoWindow({
            content: infoWindowContent
        });

        // // ì •ë³´ì°½ì„ ë°”ë¡œì—¬ëŠ”ë° ì§€ì—°ì‹œí‚¤ë©´ì„œ ì—´ê¸° (ê¹¨ì§ ë¬¸ì œ)
        // setTimeout(function() {
        //     currentInfoWindow.open(map, marker);
        // }, 100);

        // í´ë¦­ ì´ë²¤íŠ¸ ìœ ì§€
        naver.maps.Event.addListener(marker, "click", function() {
            if (currentInfoWindow.getMap()) {
                currentInfoWindow.close();
            } else {
                currentInfoWindow.open(map, marker);
            }
        });
    }

    // ğŸ“„ìƒì„¸ë³´ê¸° íŒì—… ê´€ë ¨ script
    function showDetails(stationId) {
        const encodedId = encodeURIComponent(stationId);
        const url = `/public-bicycle/detail/${encodedId}`;
        window.open(url, "_blank", "width=500,height=600");
    }

    // // âœ‚ï¸ì„¸ì…˜ ì§€ìš°ê¸° ê´€ë ¨ script
    // window.onbeforeunload = function () {
    //     navigator.sendBeacon("/public-bicycle/clearSession", JSON.stringify({}));
    // };

</script>
<!--ğŸ‘†ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘†-->
</body>
</html>









