<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì„¸ì´í”„ë¼ì´ë“œ: ì•ˆì „í•œ ë¼ì´ë”©ì˜ ì‹œì‘</title>
  <th:block th:replace="~{common/header :: headerFragment}"></th:block>
  <!--ğŸ‘‡ì—¬ê¸°ì— header script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->

  <!--ğŸ‘†ì—¬ê¸°ì— header script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘†-->
</head>
<body>
<div class="wrapper">
  <th:block th:replace="~{common/sidebar :: sidebarFragment}"></th:block>

  <div class="main">
    <th:block th:replace="~{common/navbar :: navbarFragment}"></th:block>
    <main class="content">
      <!--ğŸ‘‡ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
      <div class="container mt-4">
        <div th:if="${page.content.isEmpty()}">
          <p>ì‘ì„±ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <div th:unless="${page.content.isEmpty()}">
          <label for="metropolitanCity">ê´‘ì—­ìì¹˜êµ¬:</label>
          <select id="metropolitanCity" name="metropolitanCity" onchange="fetchCities()">
            <option value="">ê´‘ì—­ìì¹˜êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            <!-- ì„œë²„ì—ì„œ ë°›ì€ ê´‘ì—­ìì¹˜êµ¬ ëª©ë¡ì„ ì—¬ê¸°ì— ì¶”ê°€ -->
            <th:block th:each="city : ${metropolitanCities}">
              <option th:value="${city}" th:text="${city}"></option>
            </th:block>
          </select>

          <label for="city">ì‹œêµ°êµ¬:</label>
          <select id="city" name="city" onchange="fetchFilteredArticles()">
            <option value="">ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            <!-- ì„ íƒëœ ê´‘ì—­ìì¹˜êµ¬ì— ë”°ë¼ ì„œë²„ì—ì„œ ë°›ì€ ì‹œêµ°êµ¬ ëª©ë¡ì„ ì—¬ê¸°ì— ì¶”ê°€ -->
            <th:block th:each="city : ${cities}">
              <option th:value="${city}" th:text="${city}"></option>
            </th:block>
          </select>

          <div id="articleContainer" class="post-box">
            <div class="article_details" th:each="article : ${page.content}">
              <a th:href="@{/article/{id}(id=${article.id})}">
                <h3 th:text="${article.title}"></h3>
              </a>
              <span>ì‘ì„±ì¼ì: <span th:text="${#dates.format(article.createdAt, 'yyyy-MM-dd HH:mm')}"></span></span> <br>
              <span>ì¡°íšŒìˆ˜: <span th:text="${article.hit}"></span></span>
              <br>
            </div>
          </div>
        </div>
        <br>
        <a href="/article/create">ê¸€ ì‘ì„±</a> <br>
      </div>
      <div class="footer">
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë§í¬ ì¶”ê°€ -->
        <div th:if="${page.totalPages > 1}" class="pagination">
          <div>
            <a th:each="i : ${#numbers.sequence(0, page.totalPages-1)}"
               th:href="@{'/article?page=' + ${i}}"
               th:class="${i == page.number} ? 'active'">
              <span th:text="${i + 1}"></span>
            </a>
          </div>
        </div>
      </div>
      <!-- ğŸ‘† ì—¬ê¸°ì— ë‚´ìš© ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ ğŸ‘†-->
    </main>

    <th:block th:replace="~{common/footer :: footerFragment}"></th:block>
  </div>
</div>
</body>

<!--ğŸ‘‡ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘‡-->
<script>
    function fetchCities() {
        var metropolitanCity = document.getElementById('metropolitanCity').value;
        var citySelect = document.getElementById('city');

        // AJAX ìš”ì²­ì„ í†µí•´ ì„ íƒëœ ê´‘ì—­ìì¹˜êµ¬ì— í•´ë‹¹í•˜ëŠ” ë„ì‹œ ëª©ë¡ì„ ì„œë²„ë¡œë¶€í„° ê°€ì ¸ì˜´
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    var cities = JSON.parse(xhr.responseText);

                    // ë„ì‹œ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨
                    citySelect.innerHTML = '';
                    cities.forEach(function (city) {
                        var option = document.createElement('option');
                        option.value = city.city; // ë„ì‹œëª…ì„ ê°€ì ¸ì™€ì•¼ í•¨
                        option.textContent = city.city;
                        citySelect.appendChild(option);
                    });

                    // ë„ì‹œë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ í•„í„°ë§ëœ ê²Œì‹œê¸€ ê°€ì ¸ì˜¤ê¸°
                    fetchFilteredArticles();
                } else {
                    console.error('Failed to fetch cities');
                }
            }
        };

        xhr.open('GET', '/city?metropolitanCity=' + metropolitanCity);
        xhr.send();
    }

    function fetchFilteredArticles() {
        var metropolitanCity = document.getElementById('metropolitanCity').value;
        var city = document.getElementById('city').value;

        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    // í•„í„°ë§ëœ ê²Œì‹œê¸€ì„ í™”ë©´ì— ì—…ë°ì´íŠ¸
                    var filteredArticles = JSON.parse(xhr.responseText);
                    var articleContainer = document.getElementById('articleContainer');
                    articleContainer.innerHTML = ''; // ê¸°ì¡´ ê²Œì‹œê¸€ ì‚­ì œ

                    // í•„í„°ë§ëœ ê²Œì‹œê¸€ì„ í™”ë©´ì— ì¶”ê°€
                    filteredArticles.forEach(function (article) {
                        var articleDiv = document.createElement('div');
                        articleDiv.classList.add('article_details');

                        var titleLink = document.createElement('a');
                        titleLink.href = '/article/' + article.id;
                        titleLink.textContent = article.title;

                        var createdAtSpan = document.createElement('span');
                        // ì‘ì„±ì¼ì‹œë¥¼ Date ê°ì²´ë¡œ íŒŒì‹±
                        var createdAt = new Date(article.createdAt);
                        // ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ì‘ì„±ì¼ì‹œ í¬ë§·íŒ…
                        var formattedCreatedAt = `${createdAt.getFullYear()}-${(createdAt.getMonth() + 1).toString().padStart(2, '0')}-${createdAt.getDate().toString().padStart(2, '0')} ${createdAt.getHours().toString().padStart(2, '0')}:${createdAt.getMinutes().toString().padStart(2, '0')}`;
                        createdAtSpan.textContent = formattedCreatedAt;

                        var hitSpan = document.createElement('span');
                        hitSpan.textContent = article.hit;

                        articleDiv.appendChild(titleLink);
                        articleDiv.appendChild(createdAtSpan);
                        articleDiv.appendChild(hitSpan);

                        articleContainer.appendChild(articleDiv);
                    });
                } else {
                    console.error('Failed to fetch filtered articles');
                }
            }
        };

        xhr.open('GET', '/article/filter?metropolitanCity=' + metropolitanCity + '&city=' + city);
        xhr.send();
    }
</script>
<!--ğŸ‘†ì—¬ê¸°ì— ì‚¬ìš©í•˜ëŠ” script ë„£ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ğŸ‘†-->

<script src="/js/app.js"></script> <!-- template -->
</html>
